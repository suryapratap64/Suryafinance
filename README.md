# Supabase Project Setup — Quick Start README

This README contains a step-by-step, copy‑ready setup guide for a typical **Supabase + frontend + backend** project. It covers env vars, clients, migrations, basic RLS, profiles, and run commands.

---

## 1) Required environment variables

**Backend (`backend/.env`)**

```env
SUPABASE_URL=https://<project>.supabase.co
SUPABASE_SERVICE_ROLE_KEY=<service_role_key>  # keep secret
# OPTIONAL (only if using `pg` directly instead of supabaseAdmin.rpc):
DATABASE_URL=postgres://postgres:<password>@db.<project>.supabase.co:5432/postgres
```

**Frontend (`frontend/.env.local` for Vite)**

```env
VITE_SUPABASE_URL=https://<project>.supabase.co
VITE_SUPABASE_ANON_KEY=<anon_key>   # safe to expose in browser
```

> Replace `<project>`, `<service_role_key>`, `<anon_key>` and `<password>` with your project-specific values.

---

## 2) Install dependencies

**Backend**

```bash
cd backend
npm install @supabase/supabase-js dotenv
# Optional: if you decide to use raw PG: npm install pg
```

**Frontend**

```bash
cd frontend
npm install @supabase/supabase-js
```

---

## 3) Recommended folder structure

```
backend/
  src/
    lib/
      supabaseAdmin.ts
    migrations/
      sql/
        000_add_exec_sql.sql
        001_initial_schema.sql
        002_add_portfolio_view.sql
      migrationRunner.ts
    controllers/
    middleware/
    server.ts
  .env

frontend/
  src/
    lib/
      supabaseClient.js
    context/
      AuthContext.jsx
    components/
  .env.local
```

---

## 4) Create Supabase clients

**Backend admin client (use service role)** — `backend/src/lib/supabaseAdmin.ts`

```ts
import { createClient } from "@supabase/supabase-js";
import dotenv from "dotenv";
dotenv.config();

export const supabaseAdmin = createClient(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);
```

**Frontend public client (use anon key)** — `frontend/src/lib/supabaseClient.js`

```js
import { createClient } from '@supabase/supabase-js'

export const supabase = createClient(
  import.meta.env.VITE_SUPABASE_URL,
  import.meta.env.VITE_SUPABASE_ANON_KEY
)
```

---

## 5) Migrations: `exec_sql` RPC & runner rules

**000\_add\_exec\_sql.sql** (run first)

```sql
CREATE OR REPLACE FUNCTION exec_sql(query text) RETURNS void AS $$
BEGIN
  EXECUTE query;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**Important rules for migration runner**

* Always send the **entire SQL file content** to the RPC (`exec_sql`) — do **not** split on `;` when a file contains dollar-quoted function bodies (`$$`).
* Ensure `000_add_exec_sql.sql` runs first so subsequent migrations can use `supabaseAdmin.rpc('exec_sql', { query: sql })`.
* Track executed migrations with a `migrations` table so files run once.

---

## 6) Basic schema + RLS examples

**Tables (example)**

```sql
CREATE TABLE IF NOT EXISTS public.securities_master (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  symbol VARCHAR(50) NOT NULL UNIQUE,
  name VARCHAR(255) NOT NULL,
  security_type VARCHAR(20) CHECK (security_type IN ('STOCK','MUTUAL_FUND')),
  last_price NUMERIC(15,4),
  last_updated TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT now()
);

ALTER TABLE public.securities_master ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow read" ON public.securities_master
  FOR SELECT TO authenticated USING (true);
```

**Transactions table**

```sql
CREATE TABLE IF NOT EXISTS public.transactions (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  security_id BIGINT REFERENCES public.securities_master(id),
  transaction_type VARCHAR(4) CHECK (transaction_type IN ('BUY','SELL')),
  transaction_date DATE NOT NULL,
  quantity NUMERIC(15,4) NOT NULL,
  price_per_unit NUMERIC(15,4) NOT NULL,
  total_amount NUMERIC(20,4) NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now()
);

ALTER TABLE public.transactions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage their own transactions" ON public.transactions
  FOR ALL USING (auth.uid() = user_id);
```

**Views — important**

* **Do not** `ALTER VIEW ... ENABLE ROW LEVEL SECURITY` — RLS is only for tables.
* To restrict view reads, use `GRANT SELECT` to roles or include `WHERE auth.uid() = user_id` logic in the view.

```sql
CREATE VIEW public.portfolio_summary AS SELECT ...;
GRANT SELECT ON public.portfolio_summary TO authenticated;
```

---

## 7) Profiles & auth sync (example)

```sql
CREATE TABLE IF NOT EXISTS public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  username TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE OR REPLACE FUNCTION handle_new_user() RETURNS trigger AS $$
BEGIN
  INSERT INTO public.profiles (id, username)
  VALUES (NEW.id, (NEW.raw_user_meta_data->>'username'));
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION handle_new_user();
```

---

## 8) Frontend AuthContext (quick snippet)

```jsx
// src/context/AuthContext.jsx
import React, { createContext, useEffect, useState } from 'react'
import { supabase } from '../lib/supabaseClient'

export const AuthContext = createContext();
export const AuthProvider = ({ children }) => {
  const [user, setUser] = useState(null);
  useEffect(() => {
    supabase.auth.getSession().then(({ data }) => setUser(data.session?.user ?? null));
    supabase.auth.onAuthStateChange((_e, session) => setUser(session?.user ?? null));
  }, []);
  return <AuthContext.Provider value={{ user, supabase }}>{children}</AuthContext.Provider>
}
```

---

## 9) Backend token verification middleware

```ts
// src/middleware/verifyAuth.ts
import { supabaseAdmin } from '../lib/supabaseAdmin';

export async function verifyAuth(req, res, next) {
  const token = req.headers.authorization?.split(' ')[1];
  if (!token) return res.status(401).json({ error: 'Missing token' });

  const { data, error } = await supabaseAdmin.auth.getUser(token);
  if (error || !data.user) return res.status(401).json({ error: 'Invalid token' });

  req.user = data.user;
  next();
}
```

---

## 10) Run & development commands

**Backend**

```bash
cd backend
npm install
# run dev (ensure migration runner is invoked on server start)
npm run dev
```

**Frontend**

```bash
cd frontend
npm install
npm run dev
```

**Manual migrations (optional)**

* Ensure `000_add_exec_sql.sql` exists and has `exec_sql(query text)`.
* Run migration runner script (exists in backend startup or expose a `node src/migrations/run.js` command).

---

## Troubleshooting (common issues)

* **`Invalid supabaseUrl`**: Make sure `SUPABASE_URL` is a valid https URL (do not store DB URL in `SUPABASE_URL`).
* **`SASL: client password must be a string`**: Your `DATABASE_URL` was malformed or missing URL encoding (`@` in password must be `%40`).
* **`exec_sql` RPC not found**: Verify parameter name — function declared as `exec_sql(query text)` requires `.rpc('exec_sql',{ query })`.
* **`ALTER VIEW ... ENABLE ROW SECURITY`**: Remove — RLS is not supported on views.
* **Function dollar-quoted blocks broken**: Send the whole SQL file content when executing via RPC (do not split on `;`).

---

## Next steps I can help with

* Create a ready-to-clone boilerplate repo (backend + frontend + migrations wired).
* Generate `migrationRunner.ts` that safely sends full files to `exec_sql` and records executed files.
* Create sample migration SQL files matching your types.

Tell me which file/patch you'd like next and I will generate it for you.
